global
    maxconn 100
    log stdout format raw local0 info

defaults
    log     global
    mode    tcp
    timeout connect 10s
    timeout client  30m
    timeout server  30m

frontend postgresql_front
    bind *:5000
    mode tcp
    
    # Inspect the first packet for query type
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_len gt 0 }
    
    # Route write queries to primary
    acl write_query req.payload(0,25) -m reg -i '(?i)insert\s|update\s|delete\s|create\s|drop\s|alter\s'
    use_backend postgresql_primary if write_query
    
    # Default to secondary for reads
    default_backend postgresql_secondary

backend postgresql_primary
    mode tcp
    option pgsql-check user postgres
    server primary db-primary:5432 check weight 1 maxconn 100

backend postgresql_secondary
    mode tcp
    balance roundrobin
    option pgsql-check user postgres
    server secondary db-secondary:5432 check weight 1 maxconn 100
